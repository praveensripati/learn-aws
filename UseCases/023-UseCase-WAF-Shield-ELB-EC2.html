<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:10.0pt;
	margin-left:0in;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:10.0pt;
	margin-left:.5in;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpFirst, li.MsoListParagraphCxSpFirst, div.MsoListParagraphCxSpFirst
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpMiddle, li.MsoListParagraphCxSpMiddle, div.MsoListParagraphCxSpMiddle
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpLast, li.MsoListParagraphCxSpLast, div.MsoListParagraphCxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:10.0pt;
	margin-left:.5in;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
.MsoChpDefault
	{font-family:"Calibri",sans-serif;}
.MsoPapDefault
	{margin-bottom:10.0pt;
	line-height:115%;}
@page WordSection1
	{size:595.3pt 841.9pt;
	margin:.5in .5in .5in .5in;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>

</head>

<body lang=EN-US link=blue vlink=purple style='word-wrap:break-word'>

<div class=WordSection1>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><b><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>Use Case</span></b></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>With the
proliferation of the internet many of the companies are trying to become
global, for example Amazon has presence in many of the countries in the world.
With this expansion comes greater risk of hacking. The application stack has
become so complex that always there is some sort of vulnerability in the
different layers (OS, web, DB, network, storage, balancing etc) and the hackers
try to exploit them for financial and other benefits. Companies have to be on
their toes all the time to keep the hackers away while making sure the
legitimate users are able to access the website and other applications.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>Protecting
the publicly exposed services like websites and REST/WebServices based
interfaces consumes a lot of effort, time and money for the organizations. AWS
provides a few managed services like AWS Shield and AWS WAF (Web Application
Firewall) for mitigating the risks by the hacker.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>AWS WAF is
a service for protecting the websites and the APIs from some of the common
attacks like SQL Injection, XSS (Cross Site Scripting), SSRF (Server Side
Request Forgery) and including those published in OWASP (Open Web Application
Security Project). Custom rules can also be required tailoring to the
applications requirement.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>AWS Shield
provides support against the DDoS (Distributed Denial Of Service) attacks.
These are the types of attacks when invalid requests are sent in bulk, while
the legitimate user requests are throttled for resources. AWS Shield comes in
two editions. The Standard which is free, while the Advanced costs around 3000
USD a month with a commitment of 1 year. Because of the above-mentioned pricing
constraints, we won’t be able to use Shield advanced.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>By
default, Shield Standard is turned on for CloudFront/Route53 and there is
nothing we have to do, expect use a CloudFront distribution/Route53 which
automatically comes with Shield Standard.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal align=center style='margin-bottom:0in;text-align:center;
line-height:normal'><span lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
width=588 height=258 id="Picture 1"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image001.png"></span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>In this
use case we will create an EC2 with SSRF vulnerability application deployed on
it. Then we will try to mitigate the vulnerability using WAF. For this we need
to create an Application Load Balancer and integrate it with WAF.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><b><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>AWS
Services: </span></b><span lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>WAF,
Shield, ELB, EC2</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Go to
the IAM Management Console and create a Role for EC2 with
AmazonS3ReadOnlyAccess Policy attached to it. Make sure the name of the role is
Role4EC2-S3RO.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
width=697 height=346 id="Picture 2"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image002.jpg"></span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'><br>
-- Create an Ubuntu EC2 with the below details and connect to it.</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0in;margin-right:0in;
margin-bottom:0in;margin-left:.75in;text-indent:-.25in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>t2.micro</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0in;margin-right:0in;
margin-bottom:0in;margin-left:.75in;text-indent:-.25in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>Security
Group (22/SSH and 80/HTTP) inbound</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0in;margin-right:0in;
margin-bottom:0in;margin-left:.75in;text-indent:-.25in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>Above Role
attached</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0in;margin-right:0in;
margin-bottom:0in;margin-left:.75in;text-indent:-.25in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>Keypair
attached for authentication</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
width=698 height=347 id="Picture 3"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image003.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Execute
the below command on the EC2 and notice the Access Keys are displayed as part
of the “AccessKeyId” and “SecretAccessKey” fields. This is displayed because
it’s part of the EC2 instance metadata and can be retrieved as mentioned </span><span
lang=EN-IN><a
href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html"><span
style='font-size:12.0pt;font-family:"Verdana",sans-serif'>here</span></a></span><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>curl
http://169.254.169.254/latest/meta-data/iam/security-credentials/Role4EC2-S3RO</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=698 height=417 id="Picture 4"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image004.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Execute
the below commands in the EC2 to install Ruby and Sinatra, which is a DSL
(Domain Specific Language) for creating web applications in Ruby. Installation
of sinatra will take a few minutes for completion.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>sudo
apt-get update</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>sudo
apt-get install ruby -y</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>sudo gem
install sinatra</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- On the
EC2 create a file server.rb with the below content. This is what the program
does</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-top:0in;margin-right:0in;
margin-bottom:0in;margin-left:.75in;text-indent:-.25in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>Create a
HTTP endpoint (webserver) on port 80</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0in;margin-right:0in;
margin-bottom:0in;margin-left:.75in;text-indent:-.25in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>Takes a
URL as an input (query parameter) via HTTP</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-top:0in;margin-right:0in;
margin-bottom:0in;margin-left:.75in;text-indent:-.25in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>Invokes
the same URL via the open function</span></p>

<p class=MsoListParagraphCxSpLast style='margin-top:0in;margin-right:0in;
margin-bottom:0in;margin-left:.75in;text-indent:-.25in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>Responds
back the response from the URL</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>require
'sinatra'</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>require
'open-uri'</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>get '/' do</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>  format
'RESPONSE: %s', open(params[:url]).read</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>end</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=698 height=417 id="Picture 5"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image005.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Run the
program using the below command. Make sure to replace the IP address with the
private IP address of the EC2. The program will go in a infinite loop and if
any other command has to be run on the EC2 then a new session has to be opened.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>sudo ruby
server.rb -o <b><span style='color:red'>172.31.28.108</span></b> -p 80</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=415 id="Picture 6"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image006.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Open
the below URL in a browser and note that the AccessKeyId and the
SecretAccessKey are displayed as shown below. This happens because the program
executed above will take a URL, invoke it and send the response back. There is
no check on what the URL is and can the internal network can be probed. Make
sure to replace 34.207.208.218 with the Public IP of the EC2 instance. </span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>http://<b><span
style='color:red'>34.207.208.218</span></b>?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/Role4EC2-S3RO</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=698 height=347 id="Picture 7"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image007.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Go to
the EC2 Management Console and create a Target Group called MyTG and attach
register the above EC2 with it.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 8"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image008.jpg"></span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- In the
same EC2 Management Console, create an Application Load Balancer and specify
the Target Group as the default forwarding destination as shown below. Under
the listeners Tab, it should appear as shown below.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 10"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image009.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Make
sure to note down the DNS name of the Load Balancer.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 9"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image010.jpg"></span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Open
the below URL in the browser and the Access Keys are displayed in the browser
as there is still a vulnerability in the application. These Access Keys can be
used to read the data from S3 as we have given the Read-Only permissions to the
EC2 via the IAM Role. Make sure to replace elb.com with the DNS name of the
Load Balancer.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>http://<b><span
style='color:red'>elb.com</span></b>?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/Role4EC2-S3RO</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=698 height=347 id="Picture 11"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image011.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Now, we
will try to mitigate the vulnerability in the application using a WAF. Go to
the WAF Management Console and click on “Create web ACL”.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 12"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image012.jpg"></span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>-- Give a Name and provide some description
as shown below.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 13"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image013.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- In the
same screen, click on “Add AWS resources”.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 14"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image014.jpg"></span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>-- Make sure to select “Application Load Balancer”
and select “MyALB” the previously created Load Balancer from the list. Click on
Add.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 15"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image015.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Click
on Next.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 16"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image016.jpg"></span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>-- Click on “Add rules </span><span
lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:Wingdings'>à</span><span
lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'>
Add my own rules and rule groups”.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 17"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image017.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Make
sure to select the “Rule builder” and specify the rule name as “RuleForSSRF”
and type of rule as “Regular rule”.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 18"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image018.jpg"></span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>-- In the “If a request” select “matches the
statement” select</span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>        - “Query string” for Inspect<br>
        - “Contains string” for “Match type”<br>
        - “169.254.169.254” for “String to match”</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 19"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image019.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- For the
Action select Block. Click on “Add rule”.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 20"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image020.jpg"></span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- The
rule will be created as shown below. Click on Next.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 21"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image021.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- There
is only one rule and so need to set any priority for the rule. Click on Next.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 22"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image022.jpg"></span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Click
on Next.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 23"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image023.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Review
the web ACL and click on “Create web ACL”.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 24"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image024.jpg"></span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 25"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image025.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- The Web
ACL would be created as show below.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 26"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image026.jpg"></span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- Open
the below URL in the browser and “403 Forbidden” is displayed in the browser.
This happens because 169.254.169.254 is there the URL and this is blocked by
the WAF. Make sure to replace elb.com with the DNS name of the Load Balancer.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>http://<b><span
style='color:red'>elb.com</span></b>?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/Role4EC2-S3RO</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 27"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image027.jpg"></span></p>

<span lang=EN-IN style='font-size:12.0pt;line-height:115%;font-family:"Verdana",sans-serif'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>-- FYI,
before deleting the ACL, we need to make sure that the “Associated AWS resources”
are deleted or else AWS won’t allow the ACL to be deleted.</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;line-height:normal'><span
lang=EN-IN style='font-size:12.0pt;font-family:"Verdana",sans-serif'><img
border=0 width=697 height=346 id="Picture 28"
src="023-UseCase-WAF-Shield-ELB-EC2_files/image028.jpg"></span></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal><b><span lang=EN-IN style='font-size:12.0pt;line-height:
115%;font-family:"Verdana",sans-serif'>Conclusion</span></b></p>

<p class=MsoNormal><span lang=EN-IN style='font-size:12.0pt;line-height:115%;
font-family:"Verdana",sans-serif'>We had a vulnerability in the application and
it was displaying the Access Keys in the browser which can be exploited to get
the data from S3. Although there is still a vulnerability in the application,
we mitigated it using a custom rule in WAF.</span></p>

</div>

</body>

</html>
